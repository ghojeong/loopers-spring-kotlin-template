# Weekly I Learned 9 (ì‹¤ì‹œê°„ íˆ¬í‘œ ë­í‚¹)

## SBS ê°€ìš”ëŒ€ì „ íˆ¬í‘œ 1ìœ„ê°€ 3ì¼ì§¸ ì•ˆ ë°”ë€ŒëŠ”ë°ìš”?

ì´ë²ˆ ì£¼ëŠ” **SBS ê°€ìš”ëŒ€ì „ ì‹¤ì‹œê°„ ì•„ì´ëŒ íˆ¬í‘œ ë­í‚¹ ì‹œìŠ¤í…œ**ì„ ë§Œë“¤ì—ˆë‹¤. ì§€ë‚œì£¼ ë°©ì²­ê¶Œ í‹°ì¼€íŒ…ì— ì´ì–´ ì´ë²ˆì—” íˆ¬í‘œë‹¤.

"Redis ZSET ì“°ë©´ ë ì•„ëƒ?"ë¼ê³  ìƒê°í–ˆëŠ”ë°... ì™„ì „íˆ ë‹¤ë¥¸ ì„¸ê³„ì˜€ë‹¤.

ë­í‚¹ì€ **ë°ì´í„° êµ¬ì¡° ë¬¸ì œê°€ ì•„ë‹ˆë¼ ì‹œê°„ ê´€ë¦¬ ë¬¸ì œ**ì˜€ë‹¤.

## ì‹¤ë¬´ ìš”êµ¬ì‚¬í•­: ì‹¤ì‹œê°„ íˆ¬í‘œ ìˆœìœ„ë¥¼ ë³´ì—¬ì£¼ì„¸ìš”

ì§€ë‚œì£¼ì— ë°©ì²­ê¶Œ í‹°ì¼€íŒ…ì„ ì„±ê³µì ìœ¼ë¡œ ëë‚´ê³  ë‚˜ë‹ˆ, PDë‹˜ì´ ìƒˆë¡œìš´ ìš”êµ¬ì‚¬í•­ì„ ê°€ì ¸ì™”ë‹¤.

> "SBS ê°€ìš”ëŒ€ì „ì—ì„œ ì‹¤ì‹œê°„ ì•„ì´ëŒ íˆ¬í‘œë¥¼ ë°›ìœ¼ë ¤ê³  í•´ìš”. ì§€ê¸ˆ 1ìœ„ê°€ ëˆ„êµ¬ì¸ì§€ ì‹¤ì‹œê°„ìœ¼ë¡œ ë³´ì—¬ì£¼ì„¸ìš”. íˆ¬í‘œ ê¸°ê°„ì€ í•œ ë‹¬ì´ê³ , ë§¤ì¼ë§¤ì¼ ìˆœìœ„ê°€ ë°”ë€ŒëŠ” ê±¸ ë³´ì—¬ì£¼ê³  ì‹¶ì–´ìš”."

"ì‰½ê² ë„¤!" Redis ZSETì— íˆ¬í‘œìˆ˜ë§Œ ëˆ„ì í•˜ë©´ ë  ê²ƒ ê°™ì•˜ë‹¤.

```kotlin
// íˆ¬í‘œ ì´ë²¤íŠ¸ â†’ ì ìˆ˜ ì¦ê°€
@KafkaListener(topics = ["vote-events"])
fun handleVote(event: VoteEvent) {
    redis.zIncr("ranking:idol", event.idolId, 1.0)
}

// ë­í‚¹ ì¡°íšŒ
fun getTopIdols() = redis.zRevRange("ranking:idol", 0, 9)
```

ë°°í¬í•˜ê³  3ì¼ ì§€ì¼œë´¤ë‹¤.

## ì¶©ê²©: ì²«ë‚  1ìœ„ê°€ ê³„ì† 1ìœ„

3ì¼ í›„ ë­í‚¹ì„ í™•ì¸í–ˆëŠ”ë°... ë­”ê°€ ì´ìƒí–ˆë‹¤.

```
[12ì›” 1ì¼ ì˜¤í”ˆ ì§í›„]
1ìœ„: ì•„ì´ëŒA (íˆ¬í‘œìˆ˜: 15,000)
2ìœ„: ì•„ì´ëŒB (íˆ¬í‘œìˆ˜: 12,000)
3ìœ„: ì•„ì´ëŒC (íˆ¬í‘œìˆ˜: 10,000)

[12ì›” 3ì¼ í˜„ì¬]
1ìœ„: ì•„ì´ëŒA (íˆ¬í‘œìˆ˜: 18,000) â† ì—¬ì „íˆ 1ìœ„
2ìœ„: ì•„ì´ëŒB (íˆ¬í‘œìˆ˜: 15,000)
3ìœ„: ì•„ì´ëŒC (íˆ¬í‘œìˆ˜: 12,000)
10ìœ„: ì•„ì´ëŒD (íˆ¬í‘œìˆ˜: 8,000) â† ì–´ì œ SNSì—ì„œ ë°”ì´ëŸ´
```

PDë‹˜ì´ ë‹¹í™©í–ˆë‹¤.

> "ì–´ì œ íŠ¸ìœ„í„° íŠ¸ë Œë”© 1ìœ„ ì˜¬ëë˜ ì•„ì´ëŒDê°€ ì™œ 10ìœ„ì˜ˆìš”? ì–´ì œ í•˜ë£¨ë§Œ 5ì²œ í‘œ ë°›ì•˜ëŠ”ë°..."

### ë¬¸ì œ ë¶„ì„: Long Tail Problem

| ì•„ì´ëŒ | ì˜¤í”ˆì¼ íˆ¬í‘œ | ì–´ì œ íˆ¬í‘œ | ì˜¤ëŠ˜ íˆ¬í‘œ | ëˆ„ì  íˆ¬í‘œ | ìˆœìœ„ |
|--------|-----------|---------|---------|----------|------|
| A | 15,000 | 1,000 | 500 | 18,000 | 1ìœ„ |
| D | 0 | 5,000 | 3,000 | 8,000 | 10ìœ„ |

**ê¹¨ë‹¬ìŒ**: ëˆ„ì  íˆ¬í‘œìˆ˜ëŠ” ì‹œê°„ì´ ì§€ë‚ ìˆ˜ë¡ ì´ˆë°˜ì— ë§ì´ ë°›ì€ ì•„ì´ëŒì´ ìœ ë¦¬í•˜ë‹¤.

```
Day 1:  ì•„ì´ëŒA(15,000í‘œ) vs ì•„ì´ëŒD(0í‘œ)
Day 2:  ì•„ì´ëŒA(16,000í‘œ) vs ì•„ì´ëŒD(5,000í‘œ)  â† Dê°€ ë”°ë¼ì¡ê¸° ì–´ë ¤ì›€
Day 3:  ì•„ì´ëŒA(18,000í‘œ) vs ì•„ì´ëŒD(8,000í‘œ) â† ì–´ì œ 5ì²œí‘œ ë°›ì•„ë„ í•˜ìœ„ê¶Œ
```

**"ì‹œê°„ì´ ì§€ë‚ ìˆ˜ë¡ ì´ˆë°˜ ì¸ê¸°ê°€ ìœ ë¦¬í•œ êµ¬ì¡°ë‹¤..."**

PDë‹˜ì´ ìš”êµ¬ì‚¬í•­ì„ ë‹¤ì‹œ ì„¤ëª…í•´ì£¼ì…¨ë‹¤.

> "ì „ì²´ ëˆ„ì  ìˆœìœ„ë„ í•„ìš”í•˜ì§€ë§Œ, **'ì˜¤ëŠ˜ì˜ ì¸ê¸° ì•„ì´ëŒ', 'ì´ë²ˆ ì£¼ í•«í•œ ì•„ì´ëŒ'**ë„ ë³´ì—¬ì£¼ê³  ì‹¶ì–´ìš”. ë§¤ì¼ë§¤ì¼ ìˆœìœ„ê°€ ë°”ë€ŒëŠ” ì¬ë¯¸ê°€ ìˆì–´ì•¼ íˆ¬í‘œ ì°¸ì—¬ë„ê°€ ë†’ì•„ì§€ê±°ë“ ìš”."

## í•´ê²°ì±… 1: ì‹œê°„ ì–‘ìí™” (Time Quantization)

ë©˜í† ë‹˜ì´ íŒíŠ¸ë¥¼ ì£¼ì…¨ë‹¤.

> "ì „ì²´ ëˆ„ì ë§Œ ë³´ì—¬ì£¼ì§€ ë§ê³ , ì¼ê°„/ì‹œê°„ë³„ ë­í‚¹ë„ ë§Œë“¤ì–´ë´. ë§¤ì¼, ë§¤ì‹œê°„ ìƒˆë¡œìš´ í‚¤ë¥¼ ì“°ëŠ” ê±°ì•¼."

### ì„¤ê³„ ë³€ê²½

```kotlin
// Before: í•˜ë‚˜ì˜ í‚¤ì— ì˜ì›íˆ ëˆ„ì 
ranking:idol â†’ í•œ ë‹¬ê°„ ê³„ì† ëˆ„ì 

// After: ì‹œê°„ë³„ë¡œ í‚¤ ë¶„ë¦¬
ranking:idol:total        â†’ ì „ì²´ ëˆ„ì  (í•œ ë‹¬)
ranking:idol:daily:20251220  â†’ ì˜¤ëŠ˜ íˆ¬í‘œ
ranking:idol:daily:20251221  â†’ ë‚´ì¼ íˆ¬í‘œ
ranking:idol:hourly:2025122014  â†’ 14ì‹œ íˆ¬í‘œ
ranking:idol:hourly:2025122015  â†’ 15ì‹œ íˆ¬í‘œ
```

### êµ¬í˜„

```kotlin
data class RankingKey(
    val scope: RankingScope,      // TOTAL, DAILY, HOURLY
    val window: TimeWindow,
    val timestamp: LocalDateTime,
) {
    fun toRedisKey(): String {
        return when (window) {
            TimeWindow.TOTAL -> "ranking:idol:total"
            TimeWindow.DAILY ->
                "ranking:idol:daily:${timestamp.format(DAILY_FORMAT)}"
            TimeWindow.HOURLY ->
                "ranking:idol:hourly:${timestamp.format(HOURLY_FORMAT)}"
        }
    }
}

// Kafka Consumerì—ì„œ ì „ì²´/ì¼ê°„/ì‹œê°„ë³„ ë™ì‹œ ì—…ë°ì´íŠ¸
@KafkaListener(topics = ["vote-events"])
fun consumeVoteEvents(records: List<ConsumerRecord<String, String>>) {
    val totalKey = RankingKey.total(RankingScope.IDOL)
    val dailyKey = RankingKey.currentDaily(RankingScope.IDOL)
    val hourlyKey = RankingKey.currentHourly(RankingScope.IDOL)

    // ë°°ì¹˜ë¡œ íˆ¬í‘œìˆ˜ ëˆ„ì 
    val voteMap = mutableMapOf<Long, Int>()

    records.forEach { record ->
        val event = objectMapper.readValue<VoteEvent>(record.value())
        voteMap.merge(event.idolId, 1) { old, new -> old + new }
    }

    // Redis í•œ ë²ˆì— ì—…ë°ì´íŠ¸
    voteMap.forEach { (idolId, count) ->
        rankingRepository.incrementScore(totalKey, idolId, count.toDouble())
        rankingRepository.incrementScore(dailyKey, idolId, count.toDouble())
        rankingRepository.incrementScore(hourlyKey, idolId, count.toDouble())
    }

    // TTL ì„¤ì • (ì¼ê°„ 7ì¼, ì‹œê°„ë³„ 1ì¼)
    rankingRepository.setExpire(dailyKey)
    rankingRepository.setExpire(hourlyKey)
}
```

### ê²°ê³¼

```
[ì „ì²´ ëˆ„ì  ìˆœìœ„]
1ìœ„: ì•„ì´ëŒA (18,000í‘œ)
2ìœ„: ì•„ì´ëŒB (15,000í‘œ)
3ìœ„: ì•„ì´ëŒC (12,000í‘œ)

[ì˜¤ëŠ˜ì˜ ìˆœìœ„]
1ìœ„: ì•„ì´ëŒD (3,000í‘œ) â† ì˜¤ëŠ˜ í•«í•œ ì•„ì´ëŒ!
2ìœ„: ì•„ì´ëŒB (1,500í‘œ)
3ìœ„: ì•„ì´ëŒA (500í‘œ)

[ì§€ê¸ˆ ì´ ì‹œê°„ ìˆœìœ„ (14ì‹œ~15ì‹œ)]
1ìœ„: ì•„ì´ëŒD (800í‘œ)
2ìœ„: ì•„ì´ëŒE (600í‘œ)
3ìœ„: ì•„ì´ëŒB (400í‘œ)
```

**"ë“œë””ì–´ 'ì§€ê¸ˆ í•«í•œ ì•„ì´ëŒ'ì´ ë³´ì¸ë‹¤!"**

PDë‹˜ì´ ì¢‹ì•„í•˜ì…¨ë‹¤.

> "ì´ê±°ì•¼! ë§¤ ì‹œê°„ë§ˆë‹¤ ìˆœìœ„ê°€ ë°”ë€Œë‹ˆê¹Œ íŒ¬ë“¤ì´ ê³„ì† íˆ¬í‘œí•˜ê²Œ ë˜ë„¤ìš”!"

## ìƒˆë¡œìš´ ë¬¸ì œ: 0ì‹œê°€ ë˜ë‹ˆ ìˆœìœ„ê°€ í…… ë¹„ì—ˆì–´ìš”

ê¸°ë»í•œ ê²ƒë„ ì ì‹œ, ìƒˆë¡œìš´ ë¬¸ì œê°€ ìƒê²¼ë‹¤.

```bash
# 23:59 - ì˜¤ëŠ˜ì˜ ìˆœìœ„ ì¡°íšŒ
ranking:idol:daily:20251220
1ìœ„: ì•„ì´ëŒD (3,000í‘œ)
2ìœ„: ì•„ì´ëŒB (1,500í‘œ)

# 00:00 (1ë¶„ í›„) - ì˜¤ëŠ˜ì˜ ìˆœìœ„ ì¡°íšŒ
ranking:idol:daily:20251221
(empty) ğŸ˜±
```

**"ìƒˆ ë‚ ì´ ì‹œì‘ë˜ë©´ ìˆœìœ„ê°€ ì—†ë„¤..."**

ìƒˆë²½ 0ì‹œ, ë§¤ì‹œê°„ ì •ê°ì— íˆ¬í‘œ í˜ì´ì§€ë¥¼ ì—´ë©´ "ì•„ì§ íˆ¬í‘œê°€ ì—†ìŠµë‹ˆë‹¤" ë©”ì‹œì§€ë§Œ ë³´ì¸ë‹¤.

íŒ¬ë“¤ì´ ë‹¹í™©í•  ê²ƒ ê°™ì•˜ë‹¤.

## í•´ê²°ì±… 2: Score Carry-Over (ì½œë“œ ìŠ¤íƒ€íŠ¸ ë°©ì§€)

### ì•„ì´ë””ì–´

> "ì–´ì œ ì¸ê¸° ìˆë˜ ì•„ì´ëŒì´ ì˜¤ëŠ˜ë„ ì–´ëŠ ì •ë„ëŠ” ì¸ê¸° ìˆì„ ê±°ì•¼. ì–´ì œ ìˆœìœ„ì˜ 10%ë¥¼ ë¯¸ë¦¬ ì˜¤ëŠ˜ ìˆœìœ„ì— ë°˜ì˜í•´ë‘ë©´?"

ì™œ 10%ì¸ê°€?

| ê°€ì¤‘ì¹˜ | íš¨ê³¼ | ë¬¸ì œ |
|--------|------|------|
| 0% | ì™„ì „íˆ ìƒˆë¡œìš´ ìˆœìœ„ | ë¹ˆ ìˆœìœ„ ë…¸ì¶œ âŒ |
| 10% | ì–´ì œ 10% + ì˜¤ëŠ˜ 90% | ê· í˜•ì  âœ… |
| 50% | ê³¼ê±° ì˜ì¡´ë„ ë†’ìŒ | Long Tail ì¬ë°œ |
| 100% | ì–´ì œ ê·¸ëŒ€ë¡œ | Long Tail ì¬ë°œ âŒ |

### êµ¬í˜„

```kotlin
@Component
class RankingScheduler(
    private val rankingRepository: RankingRepository,
) {
    // ë§¤ì¼ 23:50ì— ë‚´ì¼ ìˆœìœ„ ë¯¸ë¦¬ ì¤€ë¹„
    @Scheduled(cron = "0 50 23 * * *")
    fun carryOverDailyRanking() {
        val today = LocalDate.now()
        val tomorrow = today.plusDays(1)

        val todayKey = RankingKey.daily(RankingScope.IDOL, today)
        val tomorrowKey = RankingKey.daily(RankingScope.IDOL, tomorrow)

        // 10% ê°€ì¤‘ì¹˜ë¡œ ë³µì‚¬
        rankingRepository.copyWithWeight(todayKey, tomorrowKey, 0.1)
        rankingRepository.setExpire(tomorrowKey)

        logger.info("ë‚´ì¼ ìˆœìœ„ ë¯¸ë¦¬ ì¤€ë¹„ ì™„ë£Œ: ${tomorrow}")
    }

    // ë§¤ì‹œê°„ 50ë¶„ì— ë‹¤ìŒ ì‹œê°„ ìˆœìœ„ ë¯¸ë¦¬ ì¤€ë¹„
    @Scheduled(cron = "0 50 * * * *")
    fun carryOverHourlyRanking() {
        // ë™ì¼í•œ ë¡œì§
    }
}
```

### copyWithWeight êµ¬í˜„ì—ì„œì˜ í•¨ì •

ì²˜ìŒì—” Redis `ZUNIONSTORE` ëª…ë ¹ì–´ë¥¼ ì“°ë ¤ í–ˆë‹¤.

```kotlin
// âŒ ì‹œë„í–ˆì§€ë§Œ ì‹¤íŒ¨
connection.zSetCommands().zUnionStore(
    targetKey,
    Aggregate.SUM,  // Unresolved reference 'Aggregate'
    Weights.of(weight),  // Unresolved reference 'Weights'
    sourceKey
)
```

**ë¬¸ì œ**: Spring Data Redis APIê°€ ë²„ì „ë§ˆë‹¤ ë‹¬ë¼ì„œ í˜¸í™˜ì„± ë¬¸ì œ ë°œìƒ

**í•´ê²°**: ìˆ˜ë™ìœ¼ë¡œ êµ¬í˜„

```kotlin
override fun copyWithWeight(sourceKey: RankingKey, targetKey: RankingKey, weight: Double) {
    val sourceRedisKey = sourceKey.toRedisKey()
    val targetRedisKey = targetKey.toRedisKey()

    // ì›ë³¸ ZSET ì „ì²´ ì¡°íšŒ
    val items = zSetOps.reverseRangeWithScores(sourceRedisKey, 0, -1) ?: emptySet()

    if (items.isEmpty()) {
        logger.warn("ì›ë³¸ ìˆœìœ„ ë°ì´í„°ê°€ ì—†ìŒ - source=$sourceRedisKey")
        return
    }

    // ì ìˆ˜ì— ê°€ì¤‘ì¹˜ ê³±í•´ì„œ ë³µì‚¬
    items.forEach { item ->
        val idolId = item.value ?: return@forEach
        val originalVotes = item.score ?: return@forEach
        val carriedVotes = originalVotes * weight

        zSetOps.add(targetRedisKey, idolId, carriedVotes)
    }

    logger.info("ìˆœìœ„ ë³µì‚¬ ì™„ë£Œ: count=${items.size}")
}
```

**"ì˜¤íˆë ¤ ì´ê²Œ ë” ëª…í™•í•˜ê³  ë””ë²„ê¹…í•˜ê¸° ì‰½ë„¤"**

### ê²°ê³¼

```bash
# 00:00 (ìŠ¤ì¼€ì¤„ëŸ¬ ì‹¤í–‰ ì§í›„)
ranking:idol:daily:20251221
1ìœ„: ì•„ì´ëŒD (300í‘œ)  â† ì–´ì œ 3,000í‘œ Ã— 0.1
2ìœ„: ì•„ì´ëŒB (150í‘œ)  â† ì–´ì œ 1,500í‘œ Ã— 0.1

# 00:10 (ìƒˆ íˆ¬í‘œ ë°œìƒ í›„)
1ìœ„: ì•„ì´ëŒE (500í‘œ)  â† ìƒˆë²½ íŒ¬ë¤ì´ ê°•ë ¥!
2ìœ„: ì•„ì´ëŒD (350í‘œ)  â† 300 + 50 (ì–´ì œ ì¸ê¸° + ì˜¤ëŠ˜ íˆ¬í‘œ)
3ìœ„: ì•„ì´ëŒB (200í‘œ)  â† 150 + 50
```

**"ë¹ˆ ìˆœìœ„ë„ ì—†ê³ , ìƒˆë¡œìš´ ì¸ê¸° ì•„ì´ëŒë„ ì¦‰ì‹œ ë°˜ì˜ëœë‹¤!"**

## ì¶”ê°€ ê³ ë¯¼: ì¤‘ë³µ íˆ¬í‘œ ë°©ì§€ì™€ ê°€ì¤‘ì¹˜

### 1. ì¤‘ë³µ íˆ¬í‘œ ë°©ì§€

í•œ ì‚¬ëŒë‹¹ í•˜ë£¨ 1í‘œë§Œ ê°€ëŠ¥í•˜ê²Œ í•´ì•¼ í–ˆë‹¤.

```kotlin
@KafkaListener(topics = ["vote-events"])
fun consumeVoteEvents(records: List<ConsumerRecord<String, String>>) {
    records.forEach { record ->
        val event = objectMapper.readValue<VoteEvent>(record.value())

        // Redis SETNXë¡œ ì¤‘ë³µ íˆ¬í‘œ ì²´í¬ (ì´ë¯¸ WIL_5ì—ì„œ ë°°ìš´ ê²ƒ)
        val key = "vote:daily:${event.userId}:${LocalDate.now()}"
        val isFirstVote = redisTemplate.opsForValue()
            .setIfAbsent(key, "voted", Duration.ofDays(1))

        if (isFirstVote == true) {
            // íˆ¬í‘œ ì²˜ë¦¬
            rankingRepository.incrementScore(dailyKey, event.idolId, 1.0)
        } else {
            logger.warn("ì¤‘ë³µ íˆ¬í‘œ ì‹œë„: userId=${event.userId}")
        }
    }
}
```

### 2. VIP íšŒì› ê°€ì¤‘ì¹˜

PDë‹˜ì´ ì¶”ê°€ ìš”êµ¬ì‚¬í•­ì„ ê°€ì ¸ì™”ë‹¤.

> "ìœ ë£Œ ë©¤ë²„ì‹­ íšŒì›ì€ íˆ¬í‘œ ê°€ì¤‘ì¹˜ë¥¼ 2ë°°ë¡œ í•´ì£¼ì„¸ìš”."

```kotlin
data class VoteEvent(
    val userId: Long,
    val idolId: Long,
    val membershipType: MembershipType,  // FREE, VIP
) {
    fun getVoteWeight(): Double {
        return when (membershipType) {
            MembershipType.FREE -> 1.0
            MembershipType.VIP -> 2.0
        }
    }
}

// íˆ¬í‘œ ì²˜ë¦¬ ì‹œ ê°€ì¤‘ì¹˜ ë°˜ì˜
rankingRepository.incrementScore(dailyKey, event.idolId, event.getVoteWeight())
```

## ì‹¤ì „ íˆ¬ì… ê²°ê³¼

### ì„±ëŠ¥ ì§€í‘œ

**Redis ë©”ëª¨ë¦¬:**
```
ì „ì²´ ëˆ„ì : ~1MB (í•œ ë‹¬ê°„ ë³´ê´€)
ì¼ê°„ ìˆœìœ„: ~500KB Ã— 7ì¼ = ~3.5MB
ì‹œê°„ë³„ ìˆœìœ„: ~200KB Ã— 24ì‹œê°„ = ~4.8MB
ì´: ~9.3MB (ë¬´ì‹œ ê°€ëŠ¥)
```

**API ì‘ë‹µ ì‹œê°„:**
```
ìˆœìœ„ ì¡°íšŒ: ~25ms
íˆ¬í‘œ ì²˜ë¦¬: ~50ms (ì¤‘ë³µ ì²´í¬ í¬í•¨)
```

**ìŠ¤ì¼€ì¤„ëŸ¬ ì²˜ë¦¬:**
```
ì•„ì´ëŒ 100ëª… ìˆœìœ„ ë³µì‚¬: ~50ms
ì‹¤í–‰ ì‹œê°: 23:50, :50 (íˆ¬í‘œ ì ì€ ì‹œê°„)
```

### íˆ¬í‘œ í˜„í™©

**12ì›” 1ì¼ ì˜¤í”ˆ í›„ 3ì¼ê°„:**
- ì´ íˆ¬í‘œìˆ˜: **127ë§Œ í‘œ**
- í”¼í¬ RPS: **ì•½ 3,200** (ì €ë… 8ì‹œ~10ì‹œ)
- ë™ì‹œ ì ‘ì†ì: **ìµœëŒ€ 5ë§Œ ëª…**
- ì¥ì• : **0ê±´**

### PDë‹˜ ë°˜ì‘

> "ì‹œê°„ë³„ ìˆœìœ„ê°€ ê³„ì† ë°”ë€Œë‹ˆê¹Œ íŒ¬ë“¤ì´ ì‹¤ì‹œê°„ìœ¼ë¡œ íˆ¬í‘œí•˜ë„¤ìš”! ì°¸ì—¬ë„ê°€ ì‘ë…„ ëŒ€ë¹„ 3ë°° ë†’ì•„ì¡Œì–´ìš”."

## ì‹¤ì œë¡œ ë§ˆì£¼í•œ ë¬¸ì œ: ì§‘ë‹¨ íˆ¬í‘œ ì¡°ì‘ ì˜ì‹¬

íˆ¬í‘œ ì‹œì‘ 3ì¼ì§¸, ìš´ì˜íŒ€ì—ì„œ ì—°ë½ì´ ì™”ë‹¤.

> "íŠ¹ì • ì•„ì´ëŒì—ê²Œ ìƒˆë²½ 2ì‹œ~4ì‹œì— ê°‘ìê¸° 1ë§Œ í‘œê°€ ë“¤ì–´ì™”ì–´ìš”. ì˜ì‹¬ìŠ¤ëŸ¬ìš´ë° í™•ì¸ ë¶€íƒë“œë¦½ë‹ˆë‹¤."

### Kafkaë¡œ ì „ìˆ˜ ì¡°ì‚¬

ì§€ë‚œì£¼ WIL_8ì—ì„œ ë°°ìš´ Kafka offset ì¶”ì ì´ ë˜ ë„ì›€ì´ ëë‹¤.

```bash
# í•´ë‹¹ ì‹œê°„ëŒ€ íˆ¬í‘œ ì´ë²¤íŠ¸ ê²€ìƒ‰
kafka-console-consumer.sh \
  --bootstrap-server localhost:9092 \
  --topic vote-events \
  --property print.timestamp=true \
  | grep "2025-12-03T02:00" \
  | grep "idolId=7"

# ê²°ê³¼: userId íŒ¨í„´ ë¶„ì„
- userId 1000001~1010000: ìˆœì°¨ì  (ì˜ì‹¬)
- IP ì£¼ì†Œ: ëª¨ë‘ ê°™ì€ ëŒ€ì—­ (ì˜ì‹¬)
- íˆ¬í‘œ ê°„ê²©: í‰ê·  0.1ì´ˆ (ë¹„ì •ìƒ)
```

**ë°œê²¬**: ë§¤í¬ë¡œ í”„ë¡œê·¸ë¨ì„ ì´ìš©í•œ ëŒ€ëŸ‰ íˆ¬í‘œ

### ëŒ€ì‘

```kotlin
// íˆ¬í‘œ íŒ¨í„´ ê²€ì¦ ì¶”ê°€
@Component
class VoteValidator {
    fun validate(event: VoteEvent): Boolean {
        // 1. ê°™ì€ IPì—ì„œ ì´ˆë‹¹ 10í‘œ ì´ìƒ â†’ ì°¨ë‹¨
        val ipKey = "vote:ip:${event.ipAddress}"
        val voteCount = redisTemplate.opsForValue().increment(ipKey) ?: 0
        redisTemplate.expire(ipKey, Duration.ofSeconds(1))

        if (voteCount > 10) {
            logger.warn("ì˜ì‹¬ìŠ¤ëŸ¬ìš´ íˆ¬í‘œ íŒ¨í„´: IP=${event.ipAddress}")
            return false
        }

        return true
    }
}
```

**ê²°ê³¼**: ë¹„ì •ìƒ íˆ¬í‘œ 1ë§Œ í‘œ ë¬´íš¨ ì²˜ë¦¬, í•´ë‹¹ IP ì°¨ë‹¨

## ì´ë²ˆ ì£¼ ë°°ìš´ í•µì‹¬

### 1. ë­í‚¹ì€ ë°ì´í„° êµ¬ì¡°ê°€ ì•„ë‹ˆë¼ ì‹œê°„ ê´€ë¦¬ ë¬¸ì œ

ì²˜ìŒì—” "Redis ZSETë§Œ ì“°ë©´ ë"ì´ë¼ê³  ìƒê°í–ˆë‹¤.
- ëˆ„ì  ìˆœìœ„ â†’ Long Tail Problem
- ì‹œê°„ ì–‘ìí™” â†’ ì‹¤ì‹œê°„ íŠ¸ë Œë“œ ë°˜ì˜
- ì½œë“œ ìŠ¤íƒ€íŠ¸ ë°©ì§€ â†’ ì‚¬ìš©ì ê²½í—˜ ê°œì„ 

**"ë­í‚¹ì˜ í•µì‹¬ì€ 'ì‹œê°„'ì„ ì–´ë–»ê²Œ ë‹¤ë£¨ëŠëƒë‹¤"**

### 2. ì „ì²´/ì¼ê°„/ì‹œê°„ë³„ ìˆœìœ„ì˜ ì˜ë¯¸

ê° ìˆœìœ„ê°€ ë‹¤ë¥¸ ê°€ì¹˜ë¥¼ ì œê³µí•œë‹¤:
- **ì „ì²´ ëˆ„ì **: í•œ ë‹¬ê°„ì˜ ì§„ì •í•œ 1ìœ„
- **ì¼ê°„ ìˆœìœ„**: ì˜¤ëŠ˜ ê°€ì¥ í•«í•œ ì•„ì´ëŒ
- **ì‹œê°„ë³„ ìˆœìœ„**: ì§€ê¸ˆ ì´ ìˆœê°„ íŒ¬ë“¤ì´ ì‘ì›í•˜ëŠ” ì•„ì´ëŒ

**"ë‹¤ì–‘í•œ ì‹œê°„ ì¶•ìœ¼ë¡œ ë³´ë©´ ë” í’ë¶€í•œ ìŠ¤í† ë¦¬ê°€ ë‚˜ì˜¨ë‹¤"**

### 3. ë°°ì¹˜ ì²˜ë¦¬ì—ì„œ Map.merge()ì˜ ì¤‘ìš”ì„±

```kotlin
// âŒ ì˜ëª»ëœ ë°©ë²• (ë®ì–´ì“°ê¸°)
voteMap[idolId] = 1  // ê°™ì€ ì•„ì´ëŒ íˆ¬í‘œê°€ ì—¬ëŸ¬ ê°œë©´ ë§ˆì§€ë§‰ ê²ƒë§Œ

// âœ… ì˜¬ë°”ë¥¸ ë°©ë²• (ëˆ„ì )
voteMap.merge(idolId, 1) { old, new -> old + new }
```

**"ë°°ì¹˜ ì•ˆì—ì„œë„ ëª¨ë“  íˆ¬í‘œë¥¼ ì •í™•íˆ ì§‘ê³„í•´ì•¼ í•œë‹¤"**

### 4. Kafkaê°€ ë˜ ìƒëª…ì¤„ì´ ë˜ë‹¤

ë¶€ì • íˆ¬í‘œ ì¡°ì‚¬í•  ë•Œ:
- ë¡œê·¸ë§Œ ìˆì—ˆë‹¤ë©´: "ëª¨ë¥´ê² ìŠµë‹ˆë‹¤"
- **Kafkaê°€ ìˆì—ˆê¸°ì—**: ì „ìˆ˜ ì¡°ì‚¬ë¡œ íŒ¨í„´ ë°œê²¬

**"KafkaëŠ” ì´ë²¤íŠ¸ ì†Œì‹±ì˜ ê¸°ë°˜ì´ì, ê°ì‚¬(Audit)ì˜ ë§ˆì§€ë§‰ ë³´ë£¨"**

### 5. ìŠ¤ì¼€ì¤„ëŸ¬ íƒ€ì´ë°

ì½œë“œ ìŠ¤íƒ€íŠ¸ ë°©ì§€ë¥¼ ìœ„í•´:
- 23:50ì— ë‚´ì¼ ë°ì´í„° ë¯¸ë¦¬ ì¤€ë¹„
- :50ë¶„ì— ë‹¤ìŒ ì‹œê°„ ë°ì´í„° ì¤€ë¹„
- **10ë¶„ ë²„í¼ë©´ ì¶©ë¶„í•˜ë‹¤**

## SBS ê°€ìš”ëŒ€ì „ íˆ¬í‘œ ì‚¬í›„ë³´ê³ ì„œ ì‘ì„±

ë°©ì†¡ ì¢…ë£Œ í›„ ë³´ê³ ì„œì— ë‹¤ìŒê³¼ ê°™ì´ ì‘ì„±í–ˆë‹¤:

> **ì‹¤ì‹œê°„ íˆ¬í‘œ ì‹œìŠ¤í…œ ì„±ê³¼**
> 1. ì‹œê°„ ì–‘ìí™”ë¡œ ë§¤ ì‹œê°„ ìˆœìœ„ ë³€ë™ â†’ **íˆ¬í‘œ ì°¸ì—¬ë„ 3ë°° ì¦ê°€**
> 2. ì½œë“œ ìŠ¤íƒ€íŠ¸ ë°©ì§€ë¡œ ë¹ˆ ìˆœìœ„ ë…¸ì¶œ 0ê±´ â†’ **ì‚¬ìš©ì ê²½í—˜ ê°œì„ **
> 3. Kafka ê¸°ë°˜ ì´ë²¤íŠ¸ ì¶”ì ìœ¼ë¡œ ë¶€ì • íˆ¬í‘œ 1ë§Œ í‘œ ì ë°œ â†’ **ê³µì •ì„± í™•ë³´**
> 4. Redis ZSET + ë°°ì¹˜ ì²˜ë¦¬ë¡œ í”¼í¬ RPS 3,200 ì•ˆì • ëŒ€ì‘
>
> **ê²°ë¡ **: ë‹¨ìˆœ íˆ¬í‘œ ì§‘ê³„ë¥¼ ë„˜ì–´, ì‹¤ì‹œê°„ íŠ¸ë Œë“œì™€ ê³µì •ì„±ì„ ëª¨ë‘ í™•ë³´í•œ ì‹œìŠ¤í…œ

CTOë‹˜ì´ "ì‹ ì…ì´ ì´ë ‡ê²Œê¹Œì§€ ê³ ë ¤í•´ì„œ ë§Œë“  ê±´ ì²˜ìŒ"ì´ë¼ê³  ì¹­ì°¬í•´ì£¼ì…¨ë‹¤.

## ë‹¤ìŒ ì£¼ ê³„íš

SBS ê°€ìš”ëŒ€ì „ íˆ¬í‘œëŠ” ì„±ê³µì ìœ¼ë¡œ ëë‚¬ë‹¤. ë‹¤ìŒì—”:

1. **ê°œì¸í™” ì¶”ì²œ** - ìœ ì €ê°€ ì¢‹ì•„í•  ë§Œí•œ ì•„ì´ëŒ ì¶”ì²œ
2. **ì˜ˆì¸¡ ëª¨ë¸** - ìµœì¢… ê²°ê³¼ ì˜ˆì¸¡ ì‹œë®¬ë ˆì´ì…˜
3. **ì‹¤ì‹œê°„ ì•Œë¦¼** - ë‚´ê°€ íˆ¬í‘œí•œ ì•„ì´ëŒ ìˆœìœ„ ë³€ë™ í‘¸ì‹œ

ì´ë²ˆ ì£¼ë¥¼ í†µí•´ ê¹¨ë‹¬ì•˜ë‹¤. ë­í‚¹ì€ ë‹¨ìˆœíˆ ì •ë ¬ì´ ì•„ë‹ˆë¼, **ì‹œê°„ê³¼ ê³µì •ì„±ì„ ë‹¤ë£¨ëŠ” ë³µì¡í•œ ì‹œìŠ¤í…œ**ì´ë¼ëŠ” ê²ƒì„. ê·¸ë¦¬ê³  ê°€ì¥ ì¤‘ìš”í•œ ê±´:

**"ë­í‚¹ì˜ ëª©ì ì€ ìˆ«ìë¥¼ ë§¤ê¸°ëŠ” ê²Œ ì•„ë‹ˆë¼, íŒ¬ë“¤ì´ ì‘ì›í•˜ëŠ” ì¬ë¯¸ë¥¼ ëŠë¼ê²Œ í•˜ëŠ” ê²ƒ"**
