# Round 4 Quests

## Implementation Quest

주문 시, 재고/포인트/쿠폰의 정합성을 트랜잭션으로 보장하고, 동시성 이슈를 제어합니다.

- **Must-Have (무조건 구현할 것)**
  - DB 트랜잭션
  - Lock
  - 동시성 테스트

### 요구사항(쿠폰)

```json
{
  "items": [
    { "productId": 1, "quantity": 2 },
    { "productId": 3, "quantity": 1 }
  ],
  "couponId": 42 // 추가 스펙
}
```

- 주문 시에 쿠폰을 이용해 사용자가 소유한 쿠폰을 적용해 할인받을 수 있도록 합니다.
- 쿠폰은 **정액, 정률 쿠폰이 존재**하며 **재사용이 불가능**합니다.
- 존재하지 않거나 사용 불가능한 쿠폰으로 요청 시, 주문은 실패해야 합니다.

### 과제 정보

- 주문 API에 트랜잭션을 적용하고, 재고/포인트/주문 도메인의 정합성을 보장합니다.
- 동시성 이슈(Lost Update)가 발생하지 않도록 낙관적 락 또는 비관적 락을 적용합니다.
- 주요 구현 대상은 Application Layer (혹은 OrderFacade 등)에서의 트랜잭션 처리입니다.
- 동시성 이슈가 발생할 수 있는 기능에 대한 테스트가 모두 성공해야 합니다.

### 예시 (주문 처리 흐름)

```txt
1. 주문 요청
2. "주문을 위한 처리" ( 순서 무관 )
  - 쿠폰 사용 및 차감 // 동시성 이슈 위험 구간
  - 상품 재고 확인 및 차감 // 동시성 이슈 위험 구간
  - 유저 포인트 확인 및 차감 // 동시성 이슈 위험 구간
5. 주문 엔티티 생성 및 저장
```

## Checklist

### Coupon 도메인

- [ ]  쿠폰은 사용자가 소유하고 있으며, 이미 사용된 쿠폰은 사용할 수 없어야 한다.
- [ ]  쿠폰 종류는 정액 / 정률로 구분되며, 각 적용 로직을 구현하였다.
- [ ]  각 발급된 쿠폰은 최대 한번만 사용될 수 있다.

### **주문**

- [ ]  주문 전체 흐름에 대해 원자성이 보장되어야 한다.
- [ ]  사용 불가능하거나 존재하지 않는 쿠폰일 경우 주문은 실패해야 한다.
- [ ]  재고가 존재하지 않거나 부족할 경우 주문은 실패해야 한다.
- [ ]  주문 시 유저의 포인트 잔액이 부족할 경우 주문은 실패해야 한다
- [ ]  쿠폰, 재고, 포인트 처리 등 하나라도 작업이 실패하면 모두 롤백처리되어야 한다.
- [ ]  주문 성공 시, 모든 처리는 정상 반영되어야 한다.

### 동시성 테스트

- [ ]  동일한 상품에 대해 여러명이 좋아요/싫어요를 요청해도, 상품의 좋아요 개수가 정상 반영되어야 한다.
- [ ]  동일한 쿠폰으로 여러 기기에서 동시에 주문해도, 쿠폰은 단 한번만 사용되어야 한다.
- [ ]  동일한 유저가 서로 다른 주문을 동시에 수행해도, 포인트가 정상적으로 차감되어야 한다.
- [ ]  동일한 상품에 대해 여러 주문이 동시에 요청되어도, 재고가 정상적으로 차감되어야 한다.
